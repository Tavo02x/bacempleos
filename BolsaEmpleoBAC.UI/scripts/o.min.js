(function(n,t){typeof define=="function"&&define.amd?define(["q"],t):typeof exports=="object"?module.exports=t(require("q")):n.o=t(n.Q)})(this,function(n){function t(n){function i(){for(var i={},n=0,r=arguments.length,t;n<r;n++)for(t in arguments[n])arguments[n].hasOwnProperty(t)&&(i[t]=arguments[n][t]);return i}var t=this;return t.oConfig=t.oConfig||{endpoint:null,format:"json",autoFormat:!0,version:4,strictMode:!0,start:null,ready:null,error:null,headers:[],username:null,password:null,isAsync:!0,isCors:!0,openAjaxRequests:0,isHashRoute:!0,appending:"",inlinecount:!1},t.config=function(n){t.oConfig=i(t.oConfig,n)},t.countTotal=0,t.isEndpoint=function(){return t.oConfig.endpoint!==null},typeof n=="undefined"?t:new r(n,t.oConfig)}function r(t,r){function ct(){var t;return typeof n!="undefined"?n:typeof window=="undefined"?require("q"):null}function lt(n,t,r,u){if(nt(t)){var f=[];for(i=0;i<t.length;++i)f[i]="("+n+" "+r+" "+t[i][n]+")";return f.join(" "+u+" ")}return""}function dt(n,t,i){var r,f,e;i=i||(u.oConfig.version==4?"substringof":"substringof");var o=t.split(" "),h=i==="substringof"||i==="substringof",s=[];for(r=0;r<n.length;r++){if(f=[],h)for(e=0;e<o.length;e++)f.push(i+"('"+o[e]+"',"+n[r]+")");else f.push(n[r]+" "+i+" '"+t+"'");s.push("("+f.join(" and ")+")")}return s.join("or")}function a(n){var t=n||f,i,r;for(t&&t.path.length!==0||o('No resource defined. Define a resource first with o("YourResourcePath").'),i="",it&&(i=u.oConfig.endpoint+(wt(u.oConfig.endpoint,"/")?"":"/")),r=0;r<t.path.length;r++)i+=t.path[r].resource,t.path[r].get&&(i+="("+(d[t.path[r].get]||t.path[r].get)+")"),i+="/";return t.appending||(i=i.slice(0,-1)),i+t.appending+gt()}function gt(){var n="";for(queryName in f.query)f.query.hasOwnProperty(queryName)&&f.query[queryName]!=null&&(n+="&"+f.queryList[f.query[queryName]].name+"="+si(f.queryList[f.query[queryName]].value,d));return n.length>0?u.count?"?$inlinecount=allpages&"+n.substring(1):"?"+n.substring(1):""}function at(n){for(var r,f,t,i=0;i<v.length;i++)if(v[i].route.regex.test(n)){if(d={},r={},f=v[i].route.regex.exec(n),typeof v[i].route.param!="undefined"){t=1;for(prop in v[i].route.param)d[prop]=f[t],r[prop.substring(1)]=f[t],t++}else for(t=1;t<f.length;t++)d[":"+(t-1)]=f[t],r[t-1]=f[t];ht(r)||ii(v[i].callback,r);u.param=r}}function ni(n){var f=n,t,r,i;if(!(n instanceof RegExp)){for(u.oConfig.isHashRoute&&!tt(n,"#")&&(n="#"+n),t=n.split("/"),r={},i=0;i<t.length;i++)tt(t[i],":")&&(r[t[i]]=!0,t[i]="([\\w| |-]+|\\[W| |-]+)");f=new RegExp("^"+t.join("/")+"$")}return{regex:f,param:r}}function ti(n){if(JSON)return JSON.parse(JSON.stringify(n));o("No JSON Support.")}function rt(n){var r=new RegExp("'.*?'",""),i=r.exec(n),t;n=n.replace(r,"{0}");for(key in w)n=n.split(key).join(" "+w[key]+" ");if(i!=null)for(t=0;t<i.length;t++)n=n.replace("{0}",i[t]);return n}function y(n){f&&s.push(f);f=typeof n=="string"?ut(n):n;for(var t=0;t<u.oConfig.appending.length;t++)e(u.oConfig.appending[t].name,u.oConfig.appending[t].value)}function g(n,t,i,r){var l,h,c,e;if(f===null&&o('You must define a resource to perform a get(), post(), put() or delete() function. Define a resource with o("YourODataResource").'),s.length!==0||i)if(s.push(f),l=st(f.method,a()),ei(["POST","PATCH","DELETE","PUT"])<=1&&i&&!k)ot(l,pt(f.data),n,t,!1,[{name:"Accept",value:"application/json"},{name:"Content-Type",value:"application/json"}],r,s[s.length-1].progress),yt(["POST","PATCH","DELETE","PUT"]);else{for(h=vt(),c=u.oConfig.endpoint+(wt(u.oConfig.endpoint,"/")?"":"/")+"$batch",e=0;e<u.oConfig.appending.length;e++)c+=(e===0?"?":"&")+u.oConfig.appending[e].name+"="+u.oConfig.appending[e].value;ot(st("POST",c),oi(h,i),n,t,!0,[{name:"Content-Type",value:"multipart/mixed; boundary=batch_"+h}],r,s[s.length-1].progress);i&&yt(["POST","PUT","DELETE"])}else ot(st("GET",a()),null,n,t,!1,[{name:"Accept",value:"application/json,text/plain"},{name:"Content-Type",value:"application/json"}],r,f.progress)}function ii(n,t){f.path[0].resource!==""?g(n,null,!1,t):n.call(u,t)}function ri(n){return typeof n=="undefined"?u:(n.toUpperCase().indexOf("HTTP://")>-1||n.toUpperCase().indexOf("HTTPS://")>-1?it=!1:u.oConfig.endpoint||o("You can not use resource query without defining your oData endpoint. Use o().config({endpoint:yourEndpoint}) to define your oData endpoint."),routeName=n,y(n),u)}function ui(n){b("$expand")?(f.queryList[f.query.$expand].value+=","+n,f.queryList[f.query.$expand].original=f.queryList[f.query.$expand].value):e("$expand",n,n)}function ut(n){var e=n.split("?"),s=n,h="",r={path:[],appending:"",query:{},queryList:[],method:"GET",data:null,progress:null},o,f,i,t,u;if(e.length===2)for(s=e[0],h=e[1],o=h.split("&"),t=0;t<o.length;t++)f=o[t].split("="),r.queryList.push({name:f[0],value:f[1]}),r.query[f[0]]=r.queryList.length-1;for(i=s.split("/"),t=0;t<i.length;t++)tt(i[t],"$")&&i[t]!=="$link"?r.appending=i[t]:(u=i[t].split("("),u.length===1||tt(i[t],"(")?r.path.push({resource:i[t],get:null}):r.path.push({resource:u[0],get:u[1].substring(0,u[1].length-1)}));return r}function e(n,t,i,r){i=i||null;f.queryList.push({name:n,value:t,original:i});f.query[r||n]=f.queryList.length-1}function ft(n,t,i,r,u){i=i||null;r=r||" or ";n=u||n;f.queryList[f.query[n]].value="("+f.queryList[f.query[n]].value+")"+r+"("+t+")";i&&(f.queryList[f.query[n]].original=f.queryList[f.query[n]].value)}function et(n){f.query[n]=null}function c(n){if(b(n)){var t=n;return nt(t)&&(t=t.join(",")),o("There is already a depending query. You can not use them together/twice: "+t),!0}return!1}function b(n){for(var i=nt(n)?n:[n],r=!1,t=0;t<i.length;t++)f.query.hasOwnProperty(i[t])&&(r=!0);return r}function vt(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(t=="x"?i:i&7|8).toString(16)})}function p(n,t){if(typeof n!="undefined"&&n!==null&&n.length>0)return n;o(t+": Parameter must be set.")}function fi(n,t){if(typeof n=="number")return n;var i=t;return n&&n.length>0&&(isNaN(n)||(i=parseInt(n))),i}function ei(n){for(var i=0,t=0;t<s.length;t++)n.indexOf(s[t].method)>-1&&i++;return i}function yt(n){for(var i=[],t=0;t<s.length;t++)n.indexOf(s[t].method)>-1&&i.push(t);for(t=i.length-1;t>=0;t--)s.splice(i[t],1);s[0]&&(f=s[0])}function pt(n){return JSON?JSON.stringify(n):(o("No JSON support."),n)}function nt(n){return typeof Array.isArray=="undefined"?n.toString()==="[object Array]":Array.isArray(n)}function wt(n,t){return n?n.indexOf(t,n.length-t.length)!==-1:!1}function tt(n,t){return n.indexOf(t)===0}function o(n){function t(n){this.message=n;this.name="o.js exception"}if(t.prototype=new Error,u.oConfig.strictMode===!0)throw new t(n);else console.log("o.js exception: "+n)}function oi(n,t){var i="",l=vt(),v=!1,o,c,r,e,h;for(t&&(i+="--batch_"+n+"\n",i+="Content-Type: multipart/mixed; boundary=changeset_"+l+"\n\n"),o=null,u.oConfig.endpoint!==null&&(o=u.oConfig.endpoint.indexOf("://")>-1?u.oConfig.endpoint.split("/")[2]:u.oConfig.endpoint.split("/")[0],o=o.split(":")[0]),c=0;c<s.length;c++)if(r=s[c],f=r,r.method!=="GET"||t){if((r.method==="POST"||r.method==="PUT"||r.method==="PATCH"||r.method==="DELETE")&&t){for(i+="--changeset_"+l+"\n",i+="Content-Type: application/http\n",i+="Content-Transfer-Encoding: binary\n",i+="Content-ID:"+c+1+"\n\n",i+=r.method+" "+a(r)+" HTTP/1.1\n",i+="Host: "+o+"\n",e=0;e<u.oConfig.headers.length;e++)h=u.oConfig.headers[e],i+=h.name+": "+h.value+"\n";i+="Content-Type: application/json\n";i+="\n"+pt(f.data)+"\n\n\n";v=!0}}else{for(i+="--batch_"+n+"\n",i+="Content-Type: application/http\n",i+="Content-Transfer-Encoding: binary\n\n",i+=r.method+" "+a(r)+" HTTP/1.1\n",i+="Host: "+o+"\n",e=0;e<u.oConfig.headers.length;e++)h=u.oConfig.headers[e],i+=h.name+": "+h.value+"\n";i+="\n"}return v&&(i+="--changeset_"+l+"--\n\n"),i+("--batch_"+n+"--")}function ot(n,t,i,r,f,e,s,c){var v,y;if(u.oConfig.start&&h==null&&(u.oConfig.openAjaxRequests++,u.oConfig.start()),h&&h[0]&&h[0](!0),v=u,k?(n.onload=function(){n.readyState=4;n.status=200;n.onreadystatechange()},n.onerror=function(){n.readyState=0;n.status=400;n.onreadystatechange()}):typeof c=="function"&&(n.onprogress=c),n.onreadystatechange=function(){var h,c,u,t,y;if(n.readyState===4){if(n.status>=200&&n.status<300){if(n.status!==204)if(f){h=[];c=/({[\s\S]*?--batchresponse_)/g;do u=c.exec(n.responseText),u&&(kt(u[0].substring(0,u[0].length-16),v),h.push(v.data));while(u);v.data=h}else kt(n.responseText,v);l&&l.resolve(v);typeof i=="function"&&i.call(v,v.data,s)}else try{t=n.responseText;JSON&&n.responseText!=""&&(t=JSON.parse(n.responseText));t!==""&&t["odata.error"]?(y=t["odata.error"].message.value+" | HTTP Status: "+n.status+" | oData Code: "+t["odata.error"].code,o(y)):o("Request to "+a()+" failed with HTTP status "+(n.status||404)+".")}catch(e){if(bt(v,!0,n.status||404,n.responseText),typeof r=="function")r(n.status||404,e);else if(l)e.status=n.status||404,l.reject(e);else throw e;}bt(v,!1)}},u.oConfig.username&&u.oConfig.password&&(k&&o("CORS and Basic Auth is not supported for IE <= 9. Try to set isCors:false in the OData config if you do not need CORS support."),n.setRequestHeader("Authorization","Basic "+hi(u.oConfig.username+":"+u.oConfig.password))),!k){if(e)for(y=0;y<e.length;y++)n.setRequestHeader(e[y].name,e[y].value);if(u.oConfig.headers.length>0)for(y=0;y<u.oConfig.headers.length;y++)n.setRequestHeader(u.oConfig.headers[y].name,u.oConfig.headers[y].value)}n.send(t)}function bt(n,t,i,r){n.oConfig.ready&&h==null&&(n.oConfig.openAjaxRequests--,n.oConfig.openAjaxRequests<=0&&n.oConfig.ready());h&&h[1]&&h[1](!1);n.oConfig.error&&t&&n.oConfig.error(i,r)}function kt(n,t){var r=fi(n,-1),i;r!==-1?t.data=r:JSON&&n!==""?(i=JSON.parse(n),t.raw=i,i.hasOwnProperty("value")?(t.data=b(["$first"])&&i.value.length&&i.value.length<=1?i.value[0]:i.value,(i.hasOwnProperty("odata.count")||i.hasOwnProperty("@odata.count"))&&(t.inlinecount=i["odata.count"]||i["@odata.count"],Utils.countGrid=t.inlinecount)):t.data=i,f.data=t.data):t.data=n}function st(n,t){var i=null,r;return typeof window=="undefined"?(r=require("xhr2"),i=new r):i=new XMLHttpRequest,u.oConfig.isCors&&"withCredentials"in i?(i.withCredentials=!0,i.open(n,t,u.oConfig.isAsync)):u.oConfig.isCors&&typeof XDomainRequest!="undefined"?(i=new XDomainRequest,k=!0,n=="GET"?i.open(n,t):i.open("POST",t)):i.open(n,t,u.oConfig.isAsync),i}function si(){var n=arguments[0],i=arguments[1],t,r;for(t in i)r=new RegExp(t,"g"),typeof n=="string"&&(n=n.replace(r,i[t]));return n}function hi(n){var t={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(n){var e="",o,i,r,h,c,s,u,f=0;for(n=t._utf8_encode(n);f<n.length;)o=n.charCodeAt(f++),i=n.charCodeAt(f++),r=n.charCodeAt(f++),h=o>>2,c=(o&3)<<4|i>>4,s=(i&15)<<2|r>>6,u=r&63,isNaN(i)?s=u=64:isNaN(r)&&(u=64),e=e+this._keyStr.charAt(h)+this._keyStr.charAt(c)+this._keyStr.charAt(s)+this._keyStr.charAt(u);return e},_utf8_encode:function(n){var i,r,t;for(n=n.replace(/\r\n/g,"\n"),i="",r=0;r<n.length;r++)t=n.charCodeAt(r),t<128?i+=String.fromCharCode(t):t>127&&t<2048?(i+=String.fromCharCode(t>>6|192),i+=String.fromCharCode(t&63|128)):(i+=String.fromCharCode(t>>12|224),i+=String.fromCharCode(t>>6&63|128),i+=String.fromCharCode(t&63|128));return i}};return t.encode(n)}var u=this,f=null,s=[],v=[],it=!0,l=null,h=null,k=!1,ht=function(){},d={},w={"==":"eq","===":"eq","!=":"ne","!==":"ne",">":"gt",">=":"ge","<":"lt","<=":"le","&&":"and","||":"or","!":"not","*":"mul","%":"mod"};return u.data=[],u.inlinecount=null,u.param={},u.oConfig=r,u.raw=null,u.routes=u.route=function(n,t){var r,i;for(nt(n)||(n=[n]),typeof window=="undefined"&&o("Routes are only supported in a browser env."),r=window.location.hash,i=0;i<n.length;i++)typeof t!="undefined"?v.push({name:n[i],route:ni(n[i]),callback:t,param:{},interval:setInterval(function(){window.location.hash!=r&&(r=window.location.hash,at(window.location.hash))},100)}):o('Routes without a callback are not supported. Please define a function like .route("YourRoute", function() { }).');return u.triggerRoute(window.location.hash),u},u.beforeRouting=function(n){return ht=n,u},u.isEndpoint=function(){return it},u.triggerRoute=function(n){return at(n),u},u.find=function(n){return f.path[f.path.length-1].get=n,u},u.top=u.take=function(n){return c(["$top"])||e("$top",n,n),u},u.skip=function(n){return c("$skip")||e("$skip",n,n),u},u.first=function(){return c(["$top","$first"])||e("$top",1,null,"$first"),u},u.filter=u.where=function(n){if(n.length>0){var t=p(rt(n));b("$filter")?ft("$filter",t,t):e("$filter",t,t)}return u},u.apply=function(n){var t=p(rt(n));return b("$apply")?ft("$apply",t,t):e("$apply",t,t),u},u.any=function(n,t){var i=n+"/any(x:x/"+rt(p(t))+")";return b("$filter")?ft("$filter",i,i):e("$filter",i,i),u},u.orderBy=function(n,t){return typeof t=="undefined"&&(t="asc"),c("$orderby")||e("$orderby",p(n)+" "+t),u},u.orderByDesc=function(n){return u.orderBy(n,"desc")},u.select=function(n){return e("$select",p(n)),u},u.count=function(){return u.oConfig.inlinecount},u.inlineCount=function(n){return u.oConfig.version>=4?(n=n||"true",c("$inlinecount")||e("$inlinecount",allpages,allpages)):(n=n||"allpages",c("$inlinecount")||e("$inlinecount",n,n)),u},u.batch=function(n){return y(n),u},u.expand=function(n){return ui(n),u},u.loading=function(n,t){return t=t||n,h=n?[n,t]:[function(){},function(){}],u},u.ref=u.link=function(n,t,i){var r,e;return i||(i=t,t=null),et("$format"),(f==null||f.get)&&o("You need to define a resource with the find() method to append an navigation property"),u.oConfig.version<4?(f.method="POST",f.path.push("$links"),f.path.push({resource:n,get:null})):(f.method="POST",f.path.push({resource:n,get:null}),f.path.push({resource:"$ref",get:null})),r=ut(t||n),r.path[r.path.length-1].get=i,e=a(r),f.data={"@odata.id":e},u},u.removeRef=u.deleteRef=function(n,t,i){var r,s;return i||(i=t,t=null),et("$format"),(f==null||f.get)&&o("You need to define a resource with the find() method to append an navigation property"),u.oConfig.version<4?(f.method="POST",f.path.push("$links"),f.path.push({resource:n,get:null})):(f.method="POST",f.path.push({resource:n,get:null}),f.path.push({resource:"$ref",get:null})),i&&(r=ut(t||n),r.path[r.path.length-1].get=i,s=a(r),e("$id",s)),f.method="DELETE",u},u.get=function(n,t){var i=ct();return i&&typeof n=="undefined"&&(l=i.defer()),g(n,t,!1),i&&typeof n=="undefined"?l.promise:u},u.save=function(n,t){var i,r;return f.method==="GET"&&f.data!==null&&(i=ti(f),i.method="PATCH",i.data=f.data,y(i)),r=ct(),r&&typeof n=="undefined"?(l=r.defer(),g(n,t,!0),l.promise):(g(n,t,!0),u)},u.post=function(n,t){return et("$format"),t&&y(t),f.method="POST",f.data=n,u},u.patch=function(n,t){return t&&y(t),f.path[f.path.length-1]&&f.path[f.path.length-1].get||o("Bulk updates are not supported. You need to query a unique resource with find() to patch/put it."),f.method="PATCH",f.data=n,u},u.put=function(n,t){return t&&y(t),f.path[f.path.length-1]&&f.path[f.path.length-1].get||o("Bulk updates are not supported. You need to query a unique resource with find() to patch/put it."),f.method="PUT",f.data=n,u},u.remove=u["delete"]=function(n){return n&&y(n),f.path[f.path.length-1]&&f.path[f.path.length-1].get||o("Bulk deletes are not supported. You need to query a unique resource with find() to delete it."),f.method="DELETE",u},u.query=function(n){return a(n)},u.search=function(n,t,i,r){if(n!=""&&n!=undefined){var f=dt(n,t,i);u.oConfig.version==4&&r?c("$search")||e("$search",f,f):c("$filter")||e("$filter",f,f,"$search")}return u},u.filterByList=u.exclude=function(n,t){if(!c("$filter")){var i=lt(n,t,w["!="],w["&&"]);e("$filter",p(i),i)}return u},u.include=function(n,t){if(!c("$filter")){var i=lt(n,t,w["=="],w["||"]);e("$filter",p(i),i)}return u},u.progress=function(n){return f!=null&&(f.progress=n),u},ri(t)}return t});